#!/bin/bash

set -eu

RULES=()
ARGS=()
MATCH=()
SUBST=()
TMP=()
INDEX=0

usage() {
  cat <<EOF
USAGE: $0 <program> [args ...]
EOF
  exit
}
init() {
  local line
  RULES=()
  while read -r line; do
    RULES+=("$line")
  done <"$1"
  shift
  ARGS=("$@")
}
load-rule() {
  local ifs=$IFS
  set -f
  IFS=$'\t'
  TMP=(${RULES[$INDEX]})
  IFS=$ifs
}
load-match-subst() {
  local x state=before
  load-rule
  MATCH=()
  SUBST=()
  for x in "${TMP[@]}"; do
    if [[ "$x" == '$' ]]; then
      state=after
    elif [[ "$state" == before ]]; then
      MATCH+=("$x")
    elif [[ "$state" == after ]]; then
      SUBST+=("$x")
    fi
  done
  TMP=()
}
pattern-match() {
  local i=0
  for ((i=0; i<${#MATCH[@]}; i++)); do
    ((i < ${#ARGS[@]})) || return
    [[ "${ARGS[$i]}" == ${MATCH[$i]} ]] || return
  done
}
scan-match() {
  local i
  for ((INDEX=0; INDEX<${#RULES[@]}; INDEX++)); do
    load-match-subst
    pattern-match && return
  done
  return 1
}
subst() {
  local a b i=0
  for ((i=0; i<${#ARGS[@]}; i++)); do
    a=${ARGS[$i]}
    b='$'$i
    TMP=${TMP//$b/$a}
  done
}
rewrite() {
  local a=()
  for TMP in "${SUBST[@]}"; do
    subst
    a+=("$TMP")
  done
  ARGS=("${a[@]}")
  TMP=
}
run() {
  while scan-match; do
    rewrite
  done
  echo "${ARGS[@]}"
}

(($#)) || usage
init "$@"
run
