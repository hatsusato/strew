#!/bin/bash

set -eu

RULES=()
ARGS=()
MATCH=()
SUBST=()
TMP=()

init() {
  local line
  RULES=()
  while read -r line; do
    RULES+=("$line")
  done <"$1"
  shift
  ARGS=("$@")
}
load-rule() {
  local ifs=$IFS
  set -f
  IFS=$'\t'
  TMP=(${RULES[$1]})
  IFS=$ifs
}
split-rule() {
  local x state=before
  load-rule $1
  MATCH=()
  SUBST=()
  for x in "${TMP[@]}"; do
    if [[ "$x" == '$' ]]; then
      state=after
    elif [[ "$state" == before ]]; then
      MATCH+=("$x")
    elif [[ "$state" == after ]]; then
      SUBST+=("$x")
    fi
  done
}
pattern-match() {
  local i=0 m
  for m in "${MATCH[@]}"; do
    ((i < ${#ARGS[@]})) || return
    [[ "${ARGS[$i]}" == $m ]] || return
    ((i++))
  done
}

init "$@"
